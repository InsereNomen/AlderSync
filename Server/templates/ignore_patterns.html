{% extends "base.html" %}

{% block title %}Ignore Patterns - AlderSync Admin{% endblock %}

{% block content %}
<div class="container-wide">
    <h1 style="margin-bottom: 2rem;">File Ignore Patterns</h1>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Server-Side Ignore Patterns</h2>
            <button class="btn btn-primary" onclick="showAddModal()">+ Add Pattern</button>
        </div>
        <div class="card-content">
            <div class="info-banner">
                <strong>About Ignore Patterns:</strong> These patterns work like .gitignore files.
                The server will ignore any files matching these patterns during all operations.
                Supports wildcards (*), directory patterns (/), and negation (!).
            </div>

            <div id="patterns-container" style="margin-top: 1.5rem;">
                <div class="loading">Loading patterns...</div>
            </div>
        </div>
    </div>

    <!-- Information Panel -->
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">Pattern Syntax</h2>
        </div>
        <div class="card-content">
            <div class="info-section">
                <h3>Wildcards</h3>
                <ul>
                    <li><code>*</code> matches any characters (e.g., <code>*.tmp</code> matches all .tmp files)</li>
                    <li><code>?</code> matches a single character</li>
                    <li><code>[abc]</code> matches any character in the brackets</li>
                </ul>
            </div>
            <div class="info-section">
                <h3>Directory Patterns</h3>
                <ul>
                    <li><code>logs/</code> matches the logs directory and all contents</li>
                    <li><code>temp/*.txt</code> matches .txt files in the temp directory</li>
                </ul>
            </div>
            <div class="info-section">
                <h3>Negation</h3>
                <ul>
                    <li><code>!important.log</code> negates a previous ignore pattern (un-ignores the file)</li>
                </ul>
            </div>
            <div class="info-section">
                <h3>Examples</h3>
                <ul>
                    <li><code>*.tmp</code> - Ignore all temporary files</li>
                    <li><code>*.log</code> - Ignore all log files</li>
                    <li><code>.DS_Store</code> - Ignore macOS metadata</li>
                    <li><code>Thumbs.db</code> - Ignore Windows thumbnails</li>
                    <li><code>cache/</code> - Ignore cache directory</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Pattern Modal -->
<div id="pattern-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Add Ignore Pattern</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="pattern-form" onsubmit="savePattern(event)">
                <input type="hidden" id="pattern-id" value="">

                <div class="form-group">
                    <label for="pattern">Pattern *</label>
                    <input type="text"
                           id="pattern"
                           name="pattern"
                           class="form-control"
                           placeholder="e.g., *.tmp or logs/"
                           required>
                    <small class="form-text">Use gitignore-style syntax (wildcards, /, !)</small>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text"
                           id="description"
                           name="description"
                           class="form-control"
                           placeholder="Optional description">
                    <small class="form-text">Help others understand what this pattern ignores</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Message Notification -->
<div id="notification" class="notification" style="display: none;"></div>

<script>
    let patterns = [];

    // Load patterns on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadPatterns();
    });

    // Load patterns from server
    async function loadPatterns() {
        try {
            const response = await fetch('/admin/api/ignore-patterns', {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load patterns');
            }

            patterns = await response.json();
            renderPatterns();
        } catch (error) {
            document.getElementById('patterns-container').innerHTML =
                '<div class="error">Failed to load patterns: ' + error.message + '</div>';
            console.error('Error:', error);
        }
    }

    // Render patterns list
    function renderPatterns() {
        const container = document.getElementById('patterns-container');

        if (patterns.length === 0) {
            container.innerHTML = '<div class="empty-state">No ignore patterns defined. Add patterns to exclude files from sync operations.</div>';
            return;
        }

        let html = '<table class="patterns-table">';
        html += '<thead><tr><th>Pattern</th><th>Description</th><th>Created</th><th>Actions</th></tr></thead>';
        html += '<tbody>';

        patterns.forEach(p => {
            const created = new Date(p.created_at).toLocaleString();
            html += `<tr>
                <td><code>${escapeHtml(p.pattern)}</code></td>
                <td>${p.description ? escapeHtml(p.description) : '<em>No description</em>'}</td>
                <td>${created}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editPattern(${p.pattern_id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deletePattern(${p.pattern_id}, '${escapeHtml(p.pattern)}')">Delete</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Show add modal
    function showAddModal() {
        document.getElementById('modal-title').textContent = 'Add Ignore Pattern';
        document.getElementById('pattern-form').reset();
        document.getElementById('pattern-id').value = '';
        document.getElementById('pattern-modal').style.display = 'flex';
    }

    // Show edit modal
    function editPattern(patternId) {
        const pattern = patterns.find(p => p.pattern_id === patternId);
        if (!pattern) return;

        document.getElementById('modal-title').textContent = 'Edit Ignore Pattern';
        document.getElementById('pattern-id').value = pattern.pattern_id;
        document.getElementById('pattern').value = pattern.pattern;
        document.getElementById('description').value = pattern.description || '';
        document.getElementById('pattern-modal').style.display = 'flex';
    }

    // Close modal
    function closeModal() {
        document.getElementById('pattern-modal').style.display = 'none';
    }

    // Save pattern (create or update)
    async function savePattern(event) {
        event.preventDefault();

        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const formData = new FormData(event.target);
        const patternId = document.getElementById('pattern-id').value;
        const data = {
            pattern: formData.get('pattern').trim(),
            description: formData.get('description').trim() || null
        };

        try {
            const url = patternId
                ? `/admin/api/ignore-patterns/${patternId}`
                : '/admin/api/ignore-patterns';
            const method = patternId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                showNotification(patternId ? 'Pattern updated successfully!' : 'Pattern added successfully!', 'success');
                closeModal();
                await loadPatterns();
            } else {
                showNotification(result.detail || 'Failed to save pattern', 'error');
            }
        } catch (error) {
            showNotification('Network error: Failed to save pattern', 'error');
            console.error('Error:', error);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    }

    // Delete pattern
    async function deletePattern(patternId, patternName) {
        if (!confirm(`Delete pattern "${patternName}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/api/ignore-patterns/${patternId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();

            if (response.ok) {
                showNotification('Pattern deleted successfully!', 'success');
                await loadPatterns();
            } else {
                showNotification(result.detail || 'Failed to delete pattern', 'error');
            }
        } catch (error) {
            showNotification('Network error: Failed to delete pattern', 'error');
            console.error('Error:', error);
        }
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification notification-${type}`;
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('pattern-modal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>

<style>
    .info-banner {
        background-color: var(--bg-color);
        padding: 1rem;
        border-left: 4px solid var(--primary-color);
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .patterns-table {
        width: 100%;
        border-collapse: collapse;
    }

    .patterns-table th,
    .patterns-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .patterns-table th {
        font-weight: 600;
        background-color: var(--bg-color);
    }

    .patterns-table code {
        background-color: var(--bg-color);
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-family: monospace;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
        margin-left: 0.5rem;
    }

    .btn-danger:hover {
        background-color: #dc2626;
    }

    .loading,
    .empty-state,
    .error {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .error {
        color: #ef4444;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--card-bg);
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .close {
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-secondary);
        cursor: pointer;
        line-height: 1;
    }

    .close:hover {
        color: var(--text-color);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-text {
        display: block;
        margin-top: 0.25rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .info-section {
        margin-bottom: 1.5rem;
    }

    .info-section:last-child {
        margin-bottom: 0;
    }

    .info-section h3 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
    }

    .info-section ul {
        margin-left: 1.5rem;
        color: var(--text-secondary);
    }

    .info-section li {
        margin-bottom: 0.5rem;
    }

    .info-section code {
        background-color: var(--bg-color);
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 4px;
        background-color: var(--card-bg);
        color: var(--text-color);
        box-shadow: var(--shadow-lg);
        z-index: 2000;
        max-width: 400px;
    }

    .notification-success {
        border-left: 4px solid #10b981;
    }

    .notification-error {
        border-left: 4px solid #ef4444;
    }

    .notification-info {
        border-left: 4px solid #3b82f6;
    }
</style>

{% endblock %}
