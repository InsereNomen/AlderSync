{% extends "base.html" %}

{% block title %}Settings - AlderSync Admin{% endblock %}

{% block content %}
<div class="container-wide">
    <h1 style="margin-bottom: 2rem;">Server Settings</h1>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Configuration</h2>
        </div>
        <div class="card-content">
            <form id="settings-form" onsubmit="saveSettings(event)">
                <div class="settings-grid">
                    <!-- Lock Timeout (Pull/Push) -->
                    <div class="form-group">
                        <label for="lock_timeout_seconds">
                            Lock Timeout (Pull/Push)
                            <span class="tooltip-icon" title="Default timeout for Pull and Push operations">ⓘ</span>
                        </label>
                        <div class="input-with-unit">
                            <input type="number"
                                   id="lock_timeout_seconds"
                                   name="lock_timeout_seconds"
                                   class="form-control"
                                   min="60"
                                   max="3600"
                                   required>
                            <span class="input-unit">seconds</span>
                        </div>
                        <small class="form-text">Time before Pull/Push operations timeout (60-3600 seconds)</small>
                    </div>

                    <!-- Minimum Lock Timeout (Reconcile) -->
                    <div class="form-group">
                        <label for="min_lock_timeout_seconds">
                            Minimum Lock Timeout (Reconcile)
                            <span class="tooltip-icon" title="Minimum timeout for Reconcile operations. Actual timeout is dynamically calculated.">ⓘ</span>
                        </label>
                        <div class="input-with-unit">
                            <input type="number"
                                   id="min_lock_timeout_seconds"
                                   name="min_lock_timeout_seconds"
                                   class="form-control"
                                   min="60"
                                   max="3600"
                                   required>
                            <span class="input-unit">seconds</span>
                        </div>
                        <small class="form-text">Minimum timeout for Reconcile (60-3600 seconds). Dynamic timeout may be longer.</small>
                    </div>

                    <!-- Max Revisions -->
                    <div class="form-group">
                        <label for="max_revisions">
                            Maximum File Revisions
                            <span class="tooltip-icon" title="Number of old file versions to keep">ⓘ</span>
                        </label>
                        <input type="number"
                               id="max_revisions"
                               name="max_revisions"
                               class="form-control"
                               min="1"
                               max="100"
                               required>
                        <small class="form-text">Number of old file versions to retain (1-100)</small>
                    </div>

                    <!-- JWT Expiration -->
                    <div class="form-group">
                        <label for="jwt_expiration_hours">
                            JWT Token Expiration
                            <span class="tooltip-icon" title="How long authentication tokens remain valid">ⓘ</span>
                        </label>
                        <div class="input-with-unit">
                            <input type="number"
                                   id="jwt_expiration_hours"
                                   name="jwt_expiration_hours"
                                   class="form-control"
                                   min="1"
                                   max="168"
                                   required>
                            <span class="input-unit">hours</span>
                        </div>
                        <small class="form-text">Token validity period (1-168 hours / 7 days)</small>
                    </div>

                    <!-- Log Retention -->
                    <div class="form-group">
                        <label for="log_retention_days">
                            Log Retention Period
                            <span class="tooltip-icon" title="How long to keep server logs">ⓘ</span>
                        </label>
                        <div class="input-with-unit">
                            <input type="number"
                                   id="log_retention_days"
                                   name="log_retention_days"
                                   class="form-control"
                                   min="1"
                                   max="365"
                                   required>
                            <span class="input-unit">days</span>
                        </div>
                        <small class="form-text">Days to retain log files (1-365 days)</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn btn-primary" id="save-btn">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Information Panel -->
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">About These Settings</h2>
        </div>
        <div class="card-content">
            <div class="info-section">
                <h3>Lock Timeouts</h3>
                <p>Lock timeouts prevent operations from holding the server lock indefinitely. If an operation exceeds the timeout, the lock is automatically released.</p>
                <ul>
                    <li><strong>Pull/Push Timeout:</strong> Fixed timeout for standard operations</li>
                    <li><strong>Reconcile Timeout:</strong> Dynamically calculated based on file count and size, but never less than the minimum</li>
                </ul>
            </div>
            <div class="info-section">
                <h3>File Revisions</h3>
                <p>When a file is updated, old versions are preserved as revisions. The max revisions setting controls how many old versions to keep. When exceeded, the oldest revision is deleted.</p>
            </div>
            <div class="info-section">
                <h3>JWT Token Expiration</h3>
                <p>Authentication tokens expire after this period. Users will need to log in again after expiration. Shorter periods are more secure but require more frequent logins.</p>
            </div>
            <div class="info-section">
                <h3>Log Retention</h3>
                <p>Server logs older than this period are automatically deleted. Longer retention helps with debugging but uses more disk space.</p>
            </div>
        </div>
    </div>
</div>

<!-- Message Notification -->
<div id="notification" class="notification" style="display: none;"></div>

<script>
    let originalSettings = {};

    // Load settings on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadSettings();
    });

    // Load current settings from server
    async function loadSettings() {
        try {
            const response = await fetch('/admin/api/settings', {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load settings');
            }

            const settings = await response.json();
            originalSettings = {...settings};

            // Populate form fields
            document.getElementById('lock_timeout_seconds').value = settings.lock_timeout_seconds;
            document.getElementById('min_lock_timeout_seconds').value = settings.min_lock_timeout_seconds;
            document.getElementById('max_revisions').value = settings.max_revisions;
            document.getElementById('jwt_expiration_hours').value = settings.jwt_expiration_hours;
            document.getElementById('log_retention_days').value = settings.log_retention_days;
        } catch (error) {
            showNotification('Failed to load settings: ' + error.message, 'error');
            console.error('Error:', error);
        }
    }

    // Save settings to server
    async function saveSettings(event) {
        event.preventDefault();

        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const formData = new FormData(event.target);
        const settings = {
            lock_timeout_seconds: parseInt(formData.get('lock_timeout_seconds')),
            min_lock_timeout_seconds: parseInt(formData.get('min_lock_timeout_seconds')),
            max_revisions: parseInt(formData.get('max_revisions')),
            jwt_expiration_hours: parseInt(formData.get('jwt_expiration_hours')),
            log_retention_days: parseInt(formData.get('log_retention_days'))
        };

        try {
            const response = await fetch('/admin/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(settings)
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('Settings saved successfully!', 'success');
                originalSettings = {...settings};
            } else {
                showNotification(data.detail || 'Failed to save settings', 'error');
            }
        } catch (error) {
            showNotification('Network error: Failed to save settings', 'error');
            console.error('Error:', error);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Settings';
        }
    }

    // Reset form to original values
    function resetForm() {
        document.getElementById('lock_timeout_seconds').value = originalSettings.lock_timeout_seconds;
        document.getElementById('min_lock_timeout_seconds').value = originalSettings.min_lock_timeout_seconds;
        document.getElementById('max_revisions').value = originalSettings.max_revisions;
        document.getElementById('jwt_expiration_hours').value = originalSettings.jwt_expiration_hours;
        document.getElementById('log_retention_days').value = originalSettings.log_retention_days;
        showNotification('Form reset to saved values', 'info');
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification notification-${type}`;
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }
</script>

<style>
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
        max-width: 600px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        font-size: 1.05rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tooltip-icon {
        cursor: help;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .input-with-unit {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .input-with-unit .form-control {
        flex: 1;
    }

    .input-unit {
        color: var(--text-secondary);
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .form-control {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-text {
        display: block;
        margin-top: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 400;
        line-height: 1.4;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .info-section {
        margin-bottom: 1.5rem;
    }

    .info-section:last-child {
        margin-bottom: 0;
    }

    .info-section h3 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
    }

    .info-section p {
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }

    .info-section ul {
        margin-left: 1.5rem;
        color: var(--text-secondary);
    }

    .info-section li {
        margin-bottom: 0.25rem;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 4px;
        background-color: var(--card-bg);
        color: var(--text-color);
        box-shadow: var(--shadow-lg);
        z-index: 2000;
        max-width: 400px;
    }

    .notification-success {
        border-left: 4px solid #10b981;
    }

    .notification-error {
        border-left: 4px solid #ef4444;
    }

    .notification-info {
        border-left: 4px solid #3b82f6;
    }
</style>

{% endblock %}
