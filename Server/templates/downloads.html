{% extends "base.html" %}

{% block title %}Client Downloads - AlderSync Admin{% endblock %}

{% block content %}
<div class="container-wide">
    <h2>Client Downloads Management</h2>
    <p>Upload and manage AlderSync client versions for automatic updates.</p>

    <!-- Upload New Version Section -->
    <div class="card">
        <h3>Upload New Client Version</h3>
        <form id="upload-form" class="upload-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="version">Version (X.Y.Z format):</label>
                    <input type="text" id="version" name="version" placeholder="1.0.1" pattern="\d+\.\d+\.\d+" required>
                    <small>Must be in X.Y.Z format (e.g., 1.0.1)</small>
                </div>

                <div class="form-group">
                    <label for="platform">Platform:</label>
                    <select id="platform" name="platform" required>
                        <option value="windows">Windows (.exe or .zip)</option>
                        <option value="macos">macOS (.zip)</option>
                        <option value="linux">Linux</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="file">Client File:</label>
                <input type="file" id="file" name="file" accept=".exe,.app,.zip" required>
                <small>Select the client executable or zip file to upload</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Upload Version</button>
            </div>
        </form>

        <div id="upload-status" class="status-message" style="display: none;"></div>
    </div>

    <!-- Version List Section -->
    <div class="card">
        <h3>Uploaded Versions</h3>
        <div id="versions-loading" class="loading">Loading versions...</div>
        <div id="versions-list" style="display: none;"></div>
        <div id="versions-error" class="error-message" style="display: none;"></div>
    </div>
</div>

<style>
.container-wide {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 25px;
}

.card h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--text-color);
    border-bottom: 2px solid var(--success-color);
    padding-bottom: 10px;
}

.upload-form {
    max-width: 700px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--text-color);
}

.form-group input[type="text"],
.form-group select,
.form-group input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    background-color: var(--card-bg);
    color: var(--text-color);
}

.form-group small {
    display: block;
    margin-top: 5px;
    color: var(--text-secondary);
    font-size: 12px;
}

.form-actions {
    margin-top: 20px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-primary {
    background: var(--success-color);
    color: white;
}

.btn-primary:hover {
    opacity: 0.9;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    opacity: 0.9;
}

.btn-secondary {
    background: var(--primary-color);
    color: white;
}

.btn-secondary:hover {
    opacity: 0.9;
}

.btn-small {
    padding: 6px 12px;
    font-size: 12px;
}

.status-message {
    margin-top: 15px;
    padding: 15px;
    border-radius: 5px;
}

.status-message.success {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.status-message.error {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}

.status-message.info {
    background: rgba(37, 99, 235, 0.15);
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.loading {
    text-align: center;
    padding: 30px;
    color: var(--text-secondary);
    font-style: italic;
}

.error-message {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger-color);
    padding: 15px;
    border-radius: 5px;
    border: 1px solid var(--danger-color);
}

.versions-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.versions-table th,
.versions-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.versions-table th {
    background: var(--bg-color);
    font-weight: bold;
    color: var(--text-color);
}

.versions-table tr:hover {
    background: var(--bg-color);
    opacity: 0.8;
}

.version-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.version-badge.current {
    background: var(--success-color);
    color: white;
}

.version-badge.inactive {
    background: var(--bg-color);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.platform-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    background: #e3f2fd;
    color: #1976d2;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.no-versions {
    text-align: center;
    padding: 40px;
    color: #888;
}
</style>

<script>
let currentVersionsList = [];

// Load versions on page load
document.addEventListener('DOMContentLoaded', () => {
    loadVersions();
});

// Handle upload form submission
document.getElementById('upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const statusDiv = document.getElementById('upload-status');

    // Show loading status
    statusDiv.style.display = 'block';
    statusDiv.className = 'status-message info';
    statusDiv.textContent = 'Uploading...';

    try {
        const response = await fetch('/admin/api/downloads/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            statusDiv.className = 'status-message success';
            statusDiv.textContent = `Success! Version ${result.version} uploaded. This version is now active.`;

            // Reset form
            e.target.reset();

            // Reload versions list
            setTimeout(() => {
                loadVersions();
                statusDiv.style.display = 'none';
            }, 3000);
        } else {
            statusDiv.className = 'status-message error';
            statusDiv.textContent = `Error: ${result.detail || 'Upload failed'}`;
        }
    } catch (error) {
        statusDiv.className = 'status-message error';
        statusDiv.textContent = `Error: ${error.message}`;
    }
});

// Update file input accept attribute based on platform
document.getElementById('platform').addEventListener('change', (e) => {
    const fileInput = document.getElementById('file');
    const platform = e.target.value;

    if (platform === 'windows') {
        fileInput.accept = '.exe,.zip';
    } else if (platform === 'macos') {
        fileInput.accept = '.app,.zip';
    } else {
        fileInput.accept = '';
    }
});

// Load versions from server
async function loadVersions() {
    const loadingDiv = document.getElementById('versions-loading');
    const listDiv = document.getElementById('versions-list');
    const errorDiv = document.getElementById('versions-error');

    loadingDiv.style.display = 'block';
    listDiv.style.display = 'none';
    errorDiv.style.display = 'none';

    try {
        const response = await fetch('/admin/api/downloads/list');

        if (!response.ok) {
            throw new Error('Failed to load versions');
        }

        const data = await response.json();
        currentVersionsList = data.versions;

        loadingDiv.style.display = 'none';

        if (currentVersionsList.length === 0) {
            listDiv.style.display = 'block';
            listDiv.innerHTML = '<div class="no-versions">No versions uploaded yet.</div>';
            return;
        }

        // Build table
        let html = '<table class="versions-table">';
        html += '<thead><tr>';
        html += '<th>Version</th>';
        html += '<th>Platform</th>';
        html += '<th>Filename</th>';
        html += '<th>Size</th>';
        html += '<th>Uploaded</th>';
        html += '<th>Status</th>';
        html += '<th>Actions</th>';
        html += '</tr></thead><tbody>';

        for (const version of currentVersionsList) {
            const isCurrent = version.is_current;
            const statusBadge = isCurrent
                ? '<span class="version-badge current">ACTIVE</span>'
                : '<span class="version-badge inactive">Inactive</span>';

            html += '<tr>';
            html += `<td><strong>${version.version}</strong></td>`;
            html += `<td><span class="platform-badge">${version.platform}</span></td>`;
            html += `<td><code>${version.filename}</code></td>`;
            html += `<td>${formatFileSize(version.size)}</td>`;
            html += `<td>${formatDate(version.modified)}</td>`;
            html += `<td>${statusBadge}</td>`;
            html += '<td><div class="action-buttons">';

            if (!isCurrent) {
                html += `<button class="btn btn-secondary btn-small" onclick="setActiveVersion('${version.version}')">Set Active</button>`;
                html += `<button class="btn btn-danger btn-small" onclick="deleteVersion('${version.version}')">Delete</button>`;
            } else {
                html += '<em>Current version</em>';
            }

            html += '</div></td>';
            html += '</tr>';
        }

        html += '</tbody></table>';

        listDiv.innerHTML = html;
        listDiv.style.display = 'block';

    } catch (error) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = `Error loading versions: ${error.message}`;
    }
}

// Set a version as active
async function setActiveVersion(version) {
    if (!confirm(`Set version ${version} as the active version for client updates?`)) {
        return;
    }

    try {
        const formData = new FormData();
        formData.append('version', version);

        const response = await fetch('/admin/api/downloads/set_active', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            alert(`Version ${version} is now active`);
            loadVersions();
        } else {
            alert(`Error: ${result.detail || 'Failed to set active version'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Delete a version
async function deleteVersion(version) {
    if (!confirm(`Delete version ${version}? This cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/api/downloads/delete/${version}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            alert(`Version ${version} deleted`);
            loadVersions();
        } else {
            alert(`Error: ${result.detail || 'Failed to delete version'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// Format date
function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString();
}
</script>
{% endblock %}
